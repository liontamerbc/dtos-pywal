#!/usr/bin/env bash
# Set wallpaper and run pywal so colors follow immediately (Wayland or X11).
set -euo pipefail

if [ "$#" -lt 1 ]; then
  echo "Usage: wal-wallpaper /path/to/wallpaper" >&2
  exit 1
fi

wall="$1"

if [ ! -f "$wall" ]; then
  echo "wal-wallpaper: file not found: $wall" >&2
  exit 1
fi

SESSION_TYPE="x11"
[ "${XDG_SESSION_TYPE:-}" = "wayland" ] && SESSION_TYPE="wayland"
[ -n "${WAYLAND_DISPLAY:-}" ] && SESSION_TYPE="wayland"

set_wallpaper() {
  img="$1"
  if [ "$SESSION_TYPE" = "wayland" ]; then
    if command -v swaybg >/dev/null 2>&1; then
      pkill -x swaybg 2>/dev/null || true
      swaybg -m fill -i "$img" &
      return 0
    elif command -v swww >/dev/null 2>&1; then
      pgrep -x swww-daemon >/dev/null 2>&1 || swww-daemon &
      swww img "$img" --transition-type simple --transition-fps 30 &
      return 0
    fi
  fi

  if command -v xwallpaper >/dev/null 2>&1; then
    xwallpaper --stretch "$img" &
    return 0
  elif command -v feh >/dev/null 2>&1; then
    feh --bg-fill "$img" &
    return 0
  fi

  echo "wal-wallpaper: no wallpaper setter found (install swaybg/swww/xwallpaper/feh)" >&2
  return 1
}

run_wal() {
  img="$1"
  [ -z "$img" ] && return 0
  [ ! -f "$img" ] && return 0
  command -v wal >/dev/null 2>&1 || return 0

  postrun="$HOME/.config/wal/postrun"
  set -- wal -n -q -i "$img"
  [ -x "$postrun" ] && set -- "$@" -o "$postrun"
  if [ "$SESSION_TYPE" = "wayland" ] && [ -z "${DISPLAY:-}" ]; then
    # Avoid xrdb on pure Wayland sessions
    set -- "$@" -e
  fi
  "$@" >/dev/null 2>&1 || wal -n -q -R >/dev/null 2>&1 || true

  # Touch caches for autostart restore
  mkdir -p "$HOME/.cache"
  printf "%s\n" "$img" >"$HOME/.cache/wall_awesome"
  printf "%s\n" "$img" >"$HOME/.cache/wall_qtile"
  printf "%s\n" "$img" >"$HOME/.cache/wall"

  # Reload Qtile so widgets refresh immediately (best-effort)
  if command -v qtile >/dev/null 2>&1; then
    qtile cmd-obj -o cmd -f reload_config >/dev/null 2>&1 || true
  fi
}

set_wallpaper "$wall"
run_wal "$wall"
